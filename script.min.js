(()=>{let e={},t={};var l,s;function n(e){e=e.filter((e=>!e.isNoneTrack));let t=[];for(let l of e){let e={type:l.rawTrackType,lang_code:l.language,lang:l.languageDescription,forced:l.isForcedNarrative},s=l.ttDownloadables;s["webvtt-lssdh-ios8"]?(e.format="webvtt",e.url=Object.values(s["webvtt-lssdh-ios8"].downloadUrls)[0]):s["dfxp-ls-sdh"]?(e.format="dfxp-ls-sdh",e.url=Object.values(s["dfxp-ls-sdh"].downloadUrls)[0]):s["nflx-cmisc"]&&(e.format="nflx-cmisc",e.url=Object.values(s["nflx-cmisc"].downloadUrls)[0]),t.push(e)}return t}async function a(){if(!e.sub1)return;let t=e.tracks.text.filter((t=>t.lang_code==e.sub1))[0].url;vtt=(await fetch(t).then((e=>e.text()))).split("\n\n\n")[1].split("\n\n").map((e=>{let t=[...e.matchAll(/(\d{1,4})\n(\d{2}:\d{2}:\d{2}.\d{3}) --> (\d{2}:\d{2}:\d{2}.\d{3})([^]+?)\n([^]+)/g)][0];if(!t)return null;let l=t[2].split(":").map(parseFloat),s=t[3].split(":").map(parseFloat);return{n:parseInt(t[1]),start:3600*l[0]+60*l[1]+l[2],end:3600*s[0]+60*s[1]+s[2],style:t[4].trim(),text:t[5].replaceAll(/<[^>]*>/g,"").trim()}})).sort(((e,t)=>e&&t?e.n-t.n:0)),e.sub1_data=vtt,console.log(`[Netflix Subtitle Tools] Subtitle Loaded: ${e.sub1}`)}async function r(){if(!e.sub2)return;let t=e.tracks.text.filter((t=>t.lang_code==e.sub2))[0].url;vtt=(await fetch(t).then((e=>e.text()))).split("\n\n\n")[1].split("\n\n").map((e=>{let t=[...e.matchAll(/(\d{1,4})\n(\d{2}:\d{2}:\d{2}.\d{3}) --> (\d{2}:\d{2}:\d{2}.\d{3})([^]+?)\n([^]+)/g)][0];if(!t)return null;let l=t[2].split(":").map(parseFloat),s=t[3].split(":").map(parseFloat);return{n:parseInt(t[1]),start:3600*l[0]+60*l[1]+l[2],end:3600*s[0]+60*s[1]+s[2],style:t[4].trim(),text:t[5].replaceAll(/<[^>]*>/g,"").trim()}})).sort(((e,t)=>e&&t?e.n-t.n:0)),e.sub2_data=vtt,console.log(`[Netflix Subtitle Tools] Subtitle Loaded: ${e.sub2}`)}l=JSON.parse,s=JSON.stringify,JSON.parse=t=>{let s=l(t);return s&&s.result&&s.result.movieId&&e.video_id!==s.result.movieId&&!e.locked&&async function(t){let l={ip:t.clientIpAddress,expiration:t.expiration,video_id:t.movieId,tracks:{video:(a=t.video_tracks,a.filter((e=>!e.isNoneTrack))),audio:(s=t.audio_tracks,s.filter((e=>!e.isNoneTrack))),text:n(t.timedtexttracks)}};var s,a;console.log(l.tracks),e=l,e.locked=!0}(s.result),s},JSON.stringify=e=>{if(e&&"string"==typeof e.url&&e.url.search(new RegExp("manifest|licensedManifest"))>-1)for(let t of Object.values(e))try{t.profiles.unshift("webvtt-lssdh-ios8"),t.showAllSubDubTracks=!0}catch(e){e instanceof TypeError||console.error("[Netflix Subtitle Tools] Error: ",e)}return s(e)},window.addEventListener("load",(function(){let l=!1;new MutationObserver((s=>{s.forEach((s=>{s.addedNodes.forEach((s=>{if("DIV"==s.nodeName.toUpperCase()){let t=(s.parentNode||s).querySelector(".audio-subtitle-controller");t&&null===t.querySelector(".nst-menu")&&((()=>{let l=document.createElement("div");l.classList.add("nst-menu","nst-menu-first-sub","track-list","structural"),l.innerHTML='<h3 class="list-header">第一字幕</h3>';let s=document.createElement("ul");e.tracks.text.filter((e=>!e.forced)).forEach((t=>{let l=document.createElement("li");l.classList.add("track","nst-first-sub-selector",t.lang,t.lang_code),t.lang_code===e.sub1&&l.classList.add("selected"),l.innerHTML=t.lang,l.addEventListener("click",(()=>{e.sub1=t.lang_code,l.classList.add("selected"),localStorage.setItem("nst-first-sub",t.lang_code),a(),console.log(`[Netflix Subtitle Tools] First Subtitle: ${t.lang_code}`)})),s.appendChild(l)}));let n=document.createElement("li");n.classList.add("track","nst-first-sub-selector","close"),e.sub1||n.classList.add("selected"),n.innerHTML="關閉",n.addEventListener("click",(()=>{e.sub1=null,n.classList.add("selected"),localStorage.removeItem("nst-first-sub"),console.log("[Netflix Subtitle Tools] First Subtitle: close")})),s.appendChild(n),l.appendChild(s),t.appendChild(l);let r=s.querySelector(`.${localStorage.getItem("nst-first-sub")||"no-item-found"}`);r&&r.click()})(),(()=>{let l=document.createElement("div");l.classList.add("nst-menu","nst-menu-second-sub","track-list","structural"),l.innerHTML='<h3 class="list-header">第二字幕</h3>';let s=document.createElement("ul");e.tracks.text.filter((e=>!e.forced)).forEach((t=>{let l=document.createElement("li");l.classList.add("track","nst-second-sub-selector",t.lang,t.lang_code),t.lang_code===e.sub2&&l.classList.add("selected"),l.innerHTML=t.lang,l.addEventListener("click",(()=>{e.sub2=t.lang_code,l.classList.add("selected"),localStorage.setItem("nst-second-sub",t.lang_code),r(),console.log(`[Netflix Subtitle Tools] Second Subtitle: ${t.lang_code}`)})),s.appendChild(l)}));let n=document.createElement("li");n.classList.add("track","nst-second-sub-selector","close"),e.sub2||n.classList.add("selected"),n.innerHTML="關閉",n.addEventListener("click",(()=>{e.sub2=null,n.classList.add("selected"),localStorage.removeItem("nst-second-sub"),console.log("[Netflix Subtitle Tools] Second Subtitle: close")})),s.appendChild(n),l.appendChild(s),t.appendChild(l);let a=s.querySelector(`.${localStorage.getItem("nst-second-sub")||"no-item-found"}`);a&&a.click()})(),(()=>{let e=t.querySelector(".track-list-subtitles");e&&([...e.querySelectorAll("li")].forEach((e=>{"關閉"==e.innerText&&e.click()})),e.remove())})())}if(!l&&document.querySelector("video")){l=!0,document.querySelector("video").addEventListener("timeupdate",(()=>{try{!function(l){if(e.sub1&&e.sub1_data||e.sub2&&e.sub2_data){let s=e.sub1_data?e.sub1_data.filter((e=>!!e&&e.start<=l&&e.end>=l)):[];s.length?t.sub1.innerHTML=s[0].text:t.sub1.innerHTML="";let n=e.sub2_data?e.sub2_data.filter((e=>!!e&&e.start<=l&&e.end>=l)):[];n.length?t.sub2.innerHTML=n[0].text:t.sub2.innerHTML=""}}(document.querySelector("video").currentTime)}catch(e){}}));let s=document.createElement("div"),n=document.createElement("span"),d=document.createElement("span");s.classList.add("nst-sub-wrap"),n.classList.add("nst-sub1"),d.classList.add("nst-sub2"),s.appendChild(n),s.appendChild(d),document.querySelector("video").parentElement.appendChild(s),t.sub1=n,t.sub2=d,localStorage.getItem("nst-first-sub")&&(e.sub1=localStorage.getItem("nst-first-sub"),a()),localStorage.getItem("nst-second-sub")&&(e.sub2=localStorage.getItem("nst-second-sub"),r())}}))}))})).observe(document.body,{childList:!0,subtree:!0})}))})();