function overwrite_global_functions(){var t,s;t=JSON.parse,s=JSON.stringify,JSON.parse=e=>{e=t(e);return e&&e.result&&e.result.movieId&&(NST_MTX[Number(e.result.movieId)]=process_data(e.result),3<=location.pathname.split("/").length&&location.pathname.split("/")[2]==e.result.movieId?NST_STG=NST_MTX[Number(location.pathname.split("/")[2])]:1==Object.keys(NST_MTX).length&&(NST_STG=Object.values(NST_MTX)[0])),e},JSON.stringify=e=>{if(e&&"string"==typeof e.url&&-1<e.url.search(new RegExp("manifest|licensedManifest")))for(var t of Object.values(e))try{t.profiles.unshift("webvtt-lssdh-ios8"),t.showAllSubDubTracks=!0}catch(e){e instanceof TypeError||console.error("[NST] Error: ",e)}return s(e)},history.push_state=history.pushState,history.pushState=(...t)=>{try{console.log("[NST] History Pushed",t);let e=new URL(location.origin+t[2]);3<=e.pathname.split("/").length&&e.pathname.split("/")[2]?NST_STG=NST_MTX[Number(e.pathname.split("/")[2])]:1==Object.keys(NST_MTX).length&&(NST_STG=Object.values(NST_MTX)[0])}catch(e){console.error("[NST] History Push Error",e)}return history.push_state(...t)},history.replace_state=history.replaceState,history.replaceState=(...t)=>{try{console.log("[NST] History Replaced",t);let e=new URL(location.origin+t[2]);3<=e.pathname.split("/").length&&e.pathname.split("/")[2]?NST_STG=NST_MTX[Number(e.pathname.split("/")[2])]:1==Object.keys(NST_MTX).length&&(NST_STG=Object.values(NST_MTX)[0])}catch(e){console.error("[NST] History Replace Error",e)}return history.replace_state(...t)}}function process_data(e){return{ip:e.clientIpAddress,expiration:e.expiration,video_id:e.movieId,tracks:{video:process_video_data(e.video_tracks),audio:process_audio_data(e.audio_tracks),text:process_text_data(e.timedtexttracks)}}}function process_text_data(e){let t=[];for(var s of e=e.filter(e=>!e.isNoneTrack)){let e={type:s.rawTrackType,lang_code:s.language,lang:s.languageDescription,forced:s.isForcedNarrative};s=s.ttDownloadables;s["webvtt-lssdh-ios8"]?(e.format="webvtt",e.url=Object.values(s["webvtt-lssdh-ios8"].downloadUrls)[0]):s["dfxp-ls-sdh"]?(e.format="dfxp-ls-sdh",e.url=Object.values(s["dfxp-ls-sdh"].downloadUrls)[0]):s["nflx-cmisc"]&&(e.format="nflx-cmisc",e.url=Object.values(s["nflx-cmisc"].downloadUrls)[0]),t.push(e)}return t}function process_video_data(e){return e=e.filter(e=>!e.isNoneTrack)}function process_audio_data(e){return e=e.filter(e=>!e.isNoneTrack)}function nst_dom_handler(){setup_dom_observer(),localStorage.getItem("nst-custom-css")&&apply_custom_css(localStorage.getItem("nst-custom-css"))}function setup_dom_observer(){let e=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if("DIV"==e.nodeName.toUpperCase()){let a=(e.parentNode||e).querySelector(".audio-subtitle-controller");a&&null===a.querySelector(".nst-menu")&&((()=>{let e=document.createElement("div");e.classList.add("nst-menu","nst-menu-first-sub","track-list","structural"),e.innerHTML='<h3 class="list-header">第一字幕</h3>';let s=document.createElement("ul");NST_STG.tracks.text.filter(e=>!e.forced).forEach(e=>{let t=document.createElement("li");t.classList.add("track","nst-first-sub-selector",e.lang,e.lang_code),e.lang_code===NST_STG.sub1&&t.classList.add("selected"),t.innerHTML=e.lang,t.addEventListener("click",()=>{load_sub1(e.lang_code),[...s.querySelectorAll("li")].forEach(e=>e.classList.remove("selected")),t.classList.add("selected")}),s.appendChild(t)});let t=document.createElement("li");t.classList.add("track","nst-first-sub-selector","close"),NST_STG.sub1||t.classList.add("selected"),t.innerHTML="關閉",t.addEventListener("click",()=>{NST_STG.sub1=null,localStorage.removeItem("nst-first-sub"),[...s.querySelectorAll("li")].forEach(e=>e.classList.remove("selected")),t.classList.add("selected"),console.log("[NST] First Subtitle: null")}),s.appendChild(t),e.appendChild(s),a.appendChild(e);let l=s.querySelector(`.${localStorage.getItem("nst-first-sub")||"no-item-found"}`);l&&l.click()})(),(()=>{let e=document.createElement("div");e.classList.add("nst-menu","nst-menu-second-sub","track-list","structural"),e.innerHTML='<h3 class="list-header">第二字幕</h3>';let s=document.createElement("ul");NST_STG.tracks.text.filter(e=>!e.forced).forEach(e=>{let t=document.createElement("li");t.classList.add("track","nst-second-sub-selector",e.lang,e.lang_code),e.lang_code===NST_STG.sub2&&t.classList.add("selected"),t.innerHTML=e.lang,t.addEventListener("click",()=>{load_sub2(e.lang_code),[...s.querySelectorAll("li")].forEach(e=>e.classList.remove("selected")),t.classList.add("selected")}),s.appendChild(t)});let t=document.createElement("li");t.classList.add("track","nst-second-sub-selector","close"),NST_STG.sub2||t.classList.add("selected"),t.innerHTML="關閉",t.addEventListener("click",()=>{NST_STG.sub2=null,localStorage.removeItem("nst-second-sub"),[...s.querySelectorAll("li")].forEach(e=>e.classList.remove("selected")),t.classList.add("selected"),console.log("[NST] Second Subtitle: null")}),s.appendChild(t),e.appendChild(s),a.appendChild(e);let l=s.querySelector(`.${localStorage.getItem("nst-second-sub")||"no-item-found"}`);l&&l.click()})(),(()=>{let e=a.querySelector(".track-list-subtitles");e&&([...e.querySelectorAll("li")].forEach(e=>{"關閉"==e.innerText&&e.click()}),e.remove())})(),(()=>{let e=document.createElement("div");e.classList.add("nst-menu","nst-menu-custom-style","track-list","structural"),e.innerHTML='<h3 class="list-header">字幕樣式</h3>';let t=document.createElement("ul"),s=document.createElement("li");s.classList.add("track","nst-custom-style"),s.innerHTML="開啟樣式面板",s.addEventListener("click",()=>{document.querySelector("video").pause();let e=document.createElement("div"),t=document.createElement("div"),s=document.createElement("textarea"),l=document.createElement("button");e.classList.add("nst-custom-style-panel"),t.classList.add("nst-custom-style-panel-wrap"),s.classList.add("nst-custom-style-panel-code"),l.classList.add("nst-custom-style-panel-btn"),s.value=localStorage.getItem("nst-custom-css")||".nst-sub1 {\n\n}\n.nst-sub2 {\n\n}\n",l.innerHTML="套用格式",t.addEventListener("click",function(e){this==e.target&&this.remove()}),l.addEventListener("click",function(e){apply_custom_css(s.value),t.remove()}),t.appendChild(e),e.appendChild(s),e.appendChild(l),document.body.appendChild(t)}),t.appendChild(s),e.appendChild(t),a.appendChild(e)})())}[...document.querySelectorAll("video")].forEach(e=>{e.parentNode.classList.contains("nst-sub-inserted")||setup_subtitles(e)})})})});e.observe(document.body,{childList:!0,subtree:!0})}function setup_subtitles(e){let t=document.createElement("div"),s=document.createElement("span"),l=document.createElement("span");t.classList.add("nst-sub-wrap"),s.classList.add("nst-sub1"),l.classList.add("nst-sub2"),t.appendChild(s),t.appendChild(l),e.parentNode.appendChild(t),NST_DOM.sub1=s,NST_DOM.sub2=l,localStorage.getItem("nst-first-sub")&&(NST_STG.sub1=localStorage.getItem("nst-first-sub"),load_sub1(NST_STG.sub1)),localStorage.getItem("nst-second-sub")&&(NST_STG.sub2=localStorage.getItem("nst-second-sub"),load_sub2(NST_STG.sub2)),e.parentNode.classList.add("nst-sub-inserted"),console.log("[NST] Subtitle Elements Ready"),e.addEventListener("timeupdate",()=>{try{sub_update(e.currentTime)}catch(e){}})}function sub_update(t){var e;document.querySelector(".nst-sub-wrap")||setup_subtitles(),(NST_STG.sub1_data||NST_STG.sub2_data)&&(e=NST_STG.sub1_data?NST_STG.sub1_data.filter(e=>!!e&&(e.start<=t&&e.end>=t)):[],NST_STG.sub1&&e.length?NST_DOM.sub1.innerHTML=e[0].text:NST_DOM.sub1.innerHTML="",e=NST_STG.sub2_data?NST_STG.sub2_data.filter(e=>!!e&&(e.start<=t&&e.end>=t)):[],NST_STG.sub2&&e.length?NST_DOM.sub2.innerHTML=e[0].text:NST_DOM.sub2.innerHTML="")}window.NST_STG={},window.NST_MTX={},window.NST_DOM={},overwrite_global_functions(),window.addEventListener("load",nst_dom_handler);async function load_sub1(e){NST_STG.sub1==e&&NST_STG.sub1_data||(NST_STG.sub1=e,localStorage.setItem("nst-first-sub",e),console.log(`[NST] First Subtitle: ${e}`),e=NST_STG.tracks.text.filter(e=>e.lang_code==NST_STG.sub1)[0].url,vtt=(await fetch(e).then(e=>e.text())).split("\n\n\n")[1].split("\n\n").map(e=>{let t=[...e.matchAll(/(\d{1,4})\n(\d{2}:\d{2}:\d{2}.\d{3}) --> (\d{2}:\d{2}:\d{2}.\d{3})([^]+?)\n([^]+)/g)][0];if(!t)return null;var s=t[2].split(":").map(parseFloat),e=t[3].split(":").map(parseFloat);return{n:parseInt(t[1]),start:3600*s[0]+60*s[1]+s[2],end:3600*e[0]+60*e[1]+e[2],style:t[4].trim(),text:t[5].replaceAll(/<[^>]*>/g,"").trim()}}).sort((e,t)=>e&&t?e.n-t.n:0),NST_STG.sub1_data=vtt,console.log(`[NST] Subtitle Loaded: ${NST_STG.sub1}`))}async function load_sub2(e){NST_STG.sub2==e&&NST_STG.sub2_data||(NST_STG.sub2=e,localStorage.setItem("nst-second-sub",e),console.log(`[NST] Second Subtitle: ${e}`),e=NST_STG.tracks.text.filter(e=>e.lang_code==NST_STG.sub2)[0].url,vtt=(await fetch(e).then(e=>e.text())).split("\n\n\n")[1].split("\n\n").map(e=>{let t=[...e.matchAll(/(\d{1,4})\n(\d{2}:\d{2}:\d{2}.\d{3}) --> (\d{2}:\d{2}:\d{2}.\d{3})([^]+?)\n([^]+)/g)][0];if(!t)return null;var s=t[2].split(":").map(parseFloat),e=t[3].split(":").map(parseFloat);return{n:parseInt(t[1]),start:3600*s[0]+60*s[1]+s[2],end:3600*e[0]+60*e[1]+e[2],style:t[4].trim(),text:t[5].replaceAll(/<[^>]*>/g,"").trim()}}).sort((e,t)=>e&&t?e.n-t.n:0),NST_STG.sub2_data=vtt,console.log(`[NST] Subtitle Loaded: ${NST_STG.sub2}`))}function apply_custom_css(e){let t;document.querySelector(".nst-custom-style-loader")?t=document.querySelector(".nst-custom-style-loader"):(t=document.createElement("style"),t.classList.add("nst-custom-style-loader")),t.innerHTML=e,document.querySelector(".nst-custom-style-loader")||document.body.appendChild(t),localStorage.setItem("nst-custom-css",e),console.log("[NST] Custom CSS Applied")}